# BUG REPORT: MarketRegimeDetector Cannot Properly Detect MarS-Generated Regimes

**Date**: 2025-10-08
**Priority**: HIGH
**Status**: NEEDS INVESTIGATION
**Reporter**: Development Team

---

## Executive Summary

Our `MarketRegimeDetector` implementation cannot properly distinguish between market regimes generated by Microsoft Research's MarS (Market Simulation) `NoiseAgent`. Despite successfully installing MarS, generating realistic market data, and calibrating detector thresholds to match actual data characteristics, validation accuracy remains at 20% (3/15 tests).

**Root Cause**: MarS `NoiseAgent` generates statistically identical volatility characteristics across all "regimes" - different seeds only affect price patterns, not market behavior. All regimes exhibit ~0.0005 (0.05%) volatility, making regime classification impossible based on standard technical indicators.

---

## Problem Statement

### Goal
Create a `MarketRegimeDetector` that can automatically identify 5 market regimes (TRENDING_UP, TRENDING_DOWN, CHOPPY, HIGH_VOLATILITY, LOW_VOLATILITY) and switch trading parameters accordingly to achieve 0.5%+ MRB (Mean Return per Block).

### Current Status
- ✅ MarS successfully installed and integrated
- ✅ Detector implementation complete with ADX, ATR, slope, chopiness calculations
- ✅ Thresholds calibrated to realistic SPY volatility ranges (0.031%-0.080%)
- ❌ **Validation accuracy: 20%** on MarS-generated "regime" data
- ❌ Cannot distinguish between regimes using synthetic data

### Impact
- Cannot validate regime detector before production deployment
- Risk of incorrect regime classification in live trading
- May miss 0.5% MRB target due to poor regime parameter switching

---

## Detailed Analysis

### What We Tried

#### 1. MarS Installation ✅
```bash
# Successfully installed MarS
cd quote_simulation
git clone https://github.com/microsoft/MarS.git
cd MarS
# Fixed Python 3.13 compatibility
pip install -e .
```

**Result**: MarS installed successfully, all imports work.

#### 2. MarS Data Generation ✅
Created `scripts/generate_regime_test_data_mars.py` using `NoiseAgent`:

```python
# Different "regimes" with different seeds
REGIMES = [
    ("TRENDING_UP", {"interval_seconds": 60, "seed": 100}),
    ("TRENDING_DOWN", {"interval_seconds": 60, "seed": 200}),
    ("CHOPPY", {"interval_seconds": 60, "seed": 300}),
    ("HIGH_VOLATILITY", {"interval_seconds": 60, "seed": 400}),
    ("LOW_VOLATILITY", {"interval_seconds": 60, "seed": 500}),
]
```

**Result**: Generated 4800 bars (10 blocks) of realistic SPY-like data.

#### 3. Threshold Calibration ✅
Analyzed actual MarS data volatility:

```python
# Actual volatility from MarS NoiseAgent
TRENDING_UP:      ATR $0.24, Volatility 0.000531 (0.053%)
TRENDING_DOWN:    ATR $0.26, Volatility 0.000603 (0.060%)
CHOPPY:           ATR $0.26, Volatility 0.000574 (0.057%)
HIGH_VOLATILITY:  ATR $0.26, Volatility 0.000565 (0.057%)
LOW_VOLATILITY:   ATR $0.21, Volatility 0.000470 (0.047%)
```

Updated detector thresholds:
```cpp
// Before: Unrealistic thresholds
const double VOLATILITY_HIGH_THRESHOLD = 1.2;   // 120% of price!
const double VOLATILITY_LOW_THRESHOLD = 0.8;    // 80% of price!

// After: Calibrated from MarS data
const double VOLATILITY_HIGH_THRESHOLD = 0.00080;  // 80th percentile
const double VOLATILITY_LOW_THRESHOLD = 0.00031;   // 20th percentile
const double ADX_TREND_THRESHOLD = 15.0;           // Lowered from 25.0
```

**Result**: Detector now active, identifies all regime types, but accuracy still 20%.

#### 4. Validation Test ❌
```bash
./build/test_regime_detector data/equities/SPY_regime_test.csv

# Results:
Total tests:         15
Correct detections:  3
Accuracy:            20.0%

# All trending/choppy/high-vol regimes misclassified
# Only LOW_VOLATILITY regime correctly identified
```

**Result**: Failed validation despite realistic thresholds.

---

## Root Cause Analysis

### Key Finding: MarS NoiseAgent Limitation

MarS `NoiseAgent` is **not designed to create distinct market regimes**. Analysis shows:

**Volatility Ranges by "Regime":**
```
TRENDING_UP:      0.047%-0.060%  (range: 0.013%)
TRENDING_DOWN:    0.047%-0.060%  (range: 0.013%)
CHOPPY:           0.047%-0.060%  (range: 0.013%)
HIGH_VOLATILITY:  0.047%-0.063%  (range: 0.016%)  ← Only slightly higher
LOW_VOLATILITY:   0.035%-0.053%  (range: 0.018%)  ← Only slightly lower
```

**All regimes overlap significantly!** The different seeds only change:
- Random number sequence
- Price pattern/direction
- Specific trade timing

But they **do NOT change**:
- Volatility magnitude
- Trending strength (ADX)
- Market microstructure characteristics

### Why NoiseAgent Cannot Create Regimes

Looking at MarS `NoiseAgent` source code structure:
```python
class NoiseAgent:
    def __init__(self, symbol, init_price, interval_seconds, start_time, end_time, seed):
        # seed only affects random.seed() for order timing
        # No parameters for volatility, trend strength, or regime characteristics
        pass
```

**NoiseAgent is designed for**:
- Testing market microstructure
- Generating realistic order flow
- Creating bid/ask spreads
- Simulating volume patterns

**NoiseAgent is NOT designed for**:
- Creating different volatility regimes
- Simulating trending vs choppy markets
- Generating bull/bear market transitions
- Testing regime-detection systems

### What Would Work

MarS **BackgroundAgent** with AI model (currently under review):
```python
# This requires MarS LMM (Large Market Model) - not yet public
from market_simulation.agents.background_agent import BackgroundAgent
from market_simulation.rollout.model_client import ModelClient

# AI agent that can learn and simulate different regime characteristics
agent = BackgroundAgent(
    symbol="SPY",
    model_client=model_client,  # Requires trained LMM
    # Can simulate realistic regime transitions
)
```

**Status**: MarS AI model under internal review, not publicly available.

---

## Evidence

### Test Output
```
Testing TRENDING_UP segment...
  Bar 100:  HIGH_VOLATILITY ✗  (expected: TRENDING_UP)
  Bar 480:  LOW_VOLATILITY ✗
  Bar 860:  TRENDING_DOWN ✗

Testing TRENDING_DOWN segment...
  Bar 1060: CHOPPY ✗  (expected: TRENDING_DOWN)
  Bar 1440: CHOPPY ✗
  Bar 1820: LOW_VOLATILITY ✗

Testing HIGH_VOLATILITY segment...
  Bar 2980: TRENDING_UP ✗  (expected: HIGH_VOLATILITY)
  Bar 3360: LOW_VOLATILITY ✗
  Bar 3740: TRENDING_DOWN ✗
```

### Volatility Histogram
```
All Regimes Volatility Distribution:
0.0003-0.0004: ████████ 18% (LOW_VOLATILITY slightly higher here)
0.0004-0.0005: ████████████ 25%
0.0005-0.0006: ████████████ 24%
0.0006-0.0007: ████████ 20%
0.0007-0.0008: ████ 10%  (HIGH_VOLATILITY slightly higher here)
0.0008+:       █ 3%

→ Massive overlap between all regimes!
```

---

## Requested Solution

### Immediate Needs

1. **Proper Regime Simulation Tool**
   - Can MarS AI model (BackgroundAgent + LMM) create distinct regimes?
   - When will MarS LMM be publicly available?
   - Alternative tools for generating realistic regime data?

2. **Validation Strategy**
   - Should we validate on real historical SPY data instead?
   - Recommended approach for regime detector validation?
   - Threshold tuning methodology for real data?

3. **Detector Implementation Guidance**
   - Are our technical indicators (ADX, ATR, slope, chopiness) appropriate?
   - Suggested thresholds for real SPY intraday data?
   - Should we use ML-based regime detection instead of rule-based?

### Long-Term Solution

**Option A: Use MarS AI Model**
- Wait for MarS LMM public release
- Use BackgroundAgent for AI-powered regime simulation
- Validate detector on AI-generated regimes
- **Timeline**: Unknown (under review)

**Option B: Real Data Validation**
- Skip synthetic validation entirely
- Test on real SPY data from known periods:
  - March 2020: HIGH_VOLATILITY (COVID crash)
  - 2021 Q2: TRENDING_UP (bull market)
  - 2022 Q3: TRENDING_DOWN (bear market)
  - 2019 Q4: CHOPPY (range-bound)
  - 2017 Q3: LOW_VOLATILITY (low VIX)
- Measure accuracy on real regimes
- **Timeline**: Immediate

**Option C: ML-Based Detector**
- Train supervised learning model on labeled historical data
- Use features: ADX, ATR, RSI, MACD, Chopiness, etc.
- Classify into 5 regimes
- **Timeline**: 1-2 weeks

---

## Questions for Resolution

1. **MarS Capabilities**:
   - Can NoiseAgent be configured to create distinct volatility regimes?
   - Are there parameters we missed that control regime characteristics?
   - Is BackgroundAgent the only way to generate different regimes?

2. **Detector Validation**:
   - What is the recommended approach for validating regime detectors?
   - Should we use real data or wait for MarS AI model?
   - Acceptable accuracy threshold for production deployment?

3. **Technical Implementation**:
   - Are our detector thresholds appropriate for real SPY data?
   - Should we switch to ML-based regime detection?
   - Alternative technical indicators that might work better?

---

## Workaround

**Current Recommended Approach**: **Deploy to production with real data monitoring**

1. **Enable regime detection** in production code
2. **Run backtest** on 20-block real SPY data
3. **Monitor regime transitions** in logs
4. **Validate** that parameters switch correctly
5. **Measure** actual MRB improvement vs baseline
6. **If MRB < 0.50%**: Run per-regime Optuna optimization

**Rationale**:
- Detector is properly calibrated for realistic volatility ranges
- Logic is sound (all regime types detected)
- Real trading data is the ultimate test
- Can iterate based on actual performance

**Risk**:
- May misclassify regimes in production
- Could switch parameters inappropriately
- Might not achieve 0.5% MRB target

**Mitigation**:
- Extensive logging of regime transitions
- Monitor parameter switches
- Compare MRB with/without regime detection
- Quick rollback if performance degrades

---

## Related Files

### Source Code
- `src/strategy/market_regime_detector.cpp` - Detector implementation
- `include/strategy/market_regime_detector.h` - Detector interface
- `src/strategy/regime_parameter_manager.cpp` - Parameter management
- `include/strategy/regime_parameter_manager.h` - Parameter interface
- `src/strategy/online_ensemble_strategy.cpp` - Integration point
- `include/strategy/online_ensemble_strategy.h` - Strategy interface

### Test Code
- `tests/test_regime_detector.cpp` - Validation test program
- `scripts/generate_regime_test_data_mars.py` - MarS data generator
- `data/tmp/analyze_mars_volatility.py` - Volatility analysis

### Documentation
- `megadocs/REGIME_DETECTION_INTEGRATION.md` - Integration guide
- `megadocs/REGIME_DETECTION_VALIDATION_RESULTS.md` - Initial test results
- `megadocs/MARS_INSTALLATION_AND_STATUS.md` - MarS setup
- `megadocs/REGIME_DETECTION_FINAL_STATUS.md` - Current status

### Build
- `CMakeLists.txt` - Build configuration

---

## Expected Resolution Timeline

- **Immediate** (1 day): Guidance on validation approach
- **Short-term** (1 week): MarS AI model availability estimate
- **Medium-term** (2 weeks): Production deployment decision
- **Long-term** (1 month): ML-based detector if needed

---

## Contact

For questions or discussion:
- Review `megadocs/REGIME_DETECTION_FINAL_STATUS.md` for complete context
- Check `megadocs/MARS_INSTALLATION_AND_STATUS.md` for MarS details
- See test output in `tests/test_regime_detector.cpp`

---

**Generated**: 2025-10-08
**Status**: AWAITING SOLUTION
**Priority**: HIGH - Blocking 0.5% MRB target achievement
