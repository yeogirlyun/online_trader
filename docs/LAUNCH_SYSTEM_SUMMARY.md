# Launch System - Complete Summary

## Two Main Scripts in `scripts/` Folder

### 1. `scripts/launch_trading.sh`
**The ONE unified launcher for all trading sessions**

**Features**:
- âœ… Mock mode (replay historical data)
- âœ… Live mode (Alpaca paper trading)
- âœ… Pre-market 2-phase Optuna optimization (50 trials/phase)
- âœ… Midday re-optimization (optional)
- âœ… Auto warmup and dashboard generation

**Quick Start**:
```bash
# Mock trading (testing)
./scripts/launch_trading.sh mock

# Live trading (full workflow with optimization)
./scripts/launch_trading.sh live

# Live with midday optimization
./scripts/launch_trading.sh live --midday-optimize
```

### 2. `scripts/run_2phase_optuna.py`
**Parameter optimization engine**

**What it does**:
- Phase 1: Optimizes buy/sell thresholds, lambda, BB amplification (50 trials)
- Phase 2: Optimizes horizon weights, BB params, regularization (50 trials)  
- Uses Phase 1 best params as base for Phase 2
- Saves results to `config/best_params.json`

**Usage**:
```bash
python3 scripts/run_2phase_optuna.py \
  --data data/equities/SPY_4blocks.csv \
  --output config/best_params.json \
  --n-trials-phase1 50 \
  --n-trials-phase2 50
```

## Complete Workflow

### Pre-Market (7:00-9:00 AM ET)
```bash
./scripts/launch_trading.sh live
```
- Automatically runs 2-phase Optuna
- Saves best params to `config/best_params.json`

### Market Open (9:30 AM - 4:00 PM ET)
- Auto warmup (20 blocks + today's bars)
- Live trading with Alpaca REST API
- Midday re-optimization at 12:45 PM (if `--midday-optimize` enabled):
  - Stop trader, fetch morning bars, append to warmup
  - Optimize with updated data (25 trials/phase)
  - Restart immediately with seamless warmup and new params
- EOD position close at 3:58 PM

### Market Close (4:00 PM ET)
- Generate dashboard
- Show P&L summary
- Save logs

## Implementation Status

### âœ… Completed
1. Unified launch script (`scripts/launch_trading.sh`)
2. 2-phase Optuna optimization (`scripts/run_2phase_optuna.py`)
3. Mock mode support
4. Live mode support
5. Pre-market optimization
6. Midday re-optimization
7. Alpaca REST API methods added to C++ (`AlpacaClient::get_latest_bars()`)
8. Auto warmup and dashboard

### ðŸš§ To Do
1. **Update C++ live trader** to use Alpaca REST API instead of Polygon WebSocket
   - Currently: Uses Polygon WebSocket via Python bridge
   - Target: Direct Alpaca REST API polling (no Python bridge)
   - Location: `src/cli/live_trade_command.cpp`

## Current Architecture

### Data Flow (Current - Using Polygon)
```
Polygon WebSocket â†’ Python Bridge â†’ FIFO â†’ C++ Trader
```

### Data Flow (Target - Alpaca REST API)
```
C++ Trader â†’ Alpaca REST API (direct polling every 1 min)
```

## Next Steps

1. **Modify `src/cli/live_trade_command.cpp`**:
   - Remove Polygon WebSocket adapter
   - Remove Python bridge dependency
   - Add Alpaca REST API polling loop:
     ```cpp
     AlpacaClient alpaca(api_key, secret_key);
     while (market_open) {
         auto bars = alpaca.get_latest_bars({"SPY", "SPXL", "SH", "SDS"});
         for (auto& bar : bars) {
             strategy.on_bar(bar);
         }
         sleep(60);  // 1-minute bars
     }
     ```

2. **Update CMakeLists.txt**:
   - Remove Polygon client dependencies (if any)
   - Ensure AlpacaClient is linked

3. **Test**:
   ```bash
   # Build
   cd build && cmake --build . -j8
   
   # Test mock mode
   ../scripts/launch_trading.sh mock --data ../data/equities/SPY_4blocks.csv
   
   # Test live mode (paper trading)
   ../scripts/launch_trading.sh live --skip-optimize
   ```

4. **Clean up** (once working):
   - Remove old scripts from `tools/` folder (per user request, leave for now)
   - Update main README

## File Locations

```
scripts/
â”œâ”€â”€ launch_trading.sh       # Main unified launcher
â”œâ”€â”€ run_2phase_optuna.py    # Optimization engine
â””â”€â”€ README.md               # Documentation

config/
â””â”€â”€ best_params.json        # Optimized parameters

logs/
â”œâ”€â”€ live_trading/           # Live session logs
â””â”€â”€ mock_trading/           # Mock session logs

data/
â”œâ”€â”€ dashboards/             # HTML dashboards
â””â”€â”€ tmp/
    â””â”€â”€ midday_selected_params.json  # Current params for live trader
```

## Configuration

**Required for live trading** (`config.env`):
```bash
ALPACA_PAPER_API_KEY=your_key_here
ALPACA_PAPER_SECRET_KEY=your_secret_here
```

**Optional**: `config/best_params.json` (auto-generated by optimization)

---

**Status**: Scripts are ready. C++ live trader needs update to use Alpaca REST API.
**Last Updated**: 2025-10-09
